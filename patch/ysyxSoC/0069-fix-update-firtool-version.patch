From 8764f20a1e7d0066ff561663b1cd3bb2a30509ee Mon Sep 17 00:00:00 2001
From: Qiming Chu <cchuqiming@gmail.com>
Date: Fri, 14 Feb 2025 15:23:40 +0800
Subject: [PATCH 69/74] fix: update firtool version

This is a temporary workaround until Chisel publishes a new version that
includes the updated firtool.

The changes include:

1. Add a new script `patch/update-firtool.sh` that downloads the latest
firtool version, verifies the SHA256 checksum, and extracts it to the
`patch/firtool` directory.
2. Update the Makefile to call the `update-firtool.sh` script before
running the `mill` command to generate the Verilog file.

Signed-off-by: Qiming Chu <cchuqiming@gmail.com>
---
 Makefile                |  8 +++++
 patch/update-firtool.sh | 73 +++++++++++++++++++++++++++++++++++++++++
 2 files changed, 81 insertions(+)
 create mode 100755 patch/update-firtool.sh

diff --git a/Makefile b/Makefile
index 6d76a223..c30262ea 100644
--- a/Makefile
+++ b/Makefile
@@ -2,7 +2,15 @@ V_FILE_GEN   = build/ysyxSoCTop.sv
 V_FILE_FINAL = build/ysyxSoCFull.v
 SCALA_FILES = $(shell find src/ -name "*.scala")
 
+# Firtool version
+FIRTOOL_VERSION = 1.105.0
+FIRTOOL_PATCH_DIR = $(shell pwd)/patch/firtool
+
 $(V_FILE_FINAL): $(SCALA_FILES)
+# Replace firtool with a newer version
+# TODO: This can be removed after chisel publishes a new version
+	@./patch/update-firtool.sh $(FIRTOOL_VERSION) $(FIRTOOL_PATCH_DIR)
+	CHISEL_FIRTOOL_PATH=$(FIRTOOL_PATCH_DIR)/firtool-$(FIRTOOL_VERSION)/bin \
 	mill -i ysyxsoc.runMain ysyx.Elaborate --target-dir $(@D)
 	mv $(V_FILE_GEN) $@
 	sed -i -e 's/_\(aw\|ar\|w\|r\|b\)_\(\|bits_\)/_\1/g' $@
diff --git a/patch/update-firtool.sh b/patch/update-firtool.sh
new file mode 100755
index 00000000..cc91e5a0
--- /dev/null
+++ b/patch/update-firtool.sh
@@ -0,0 +1,73 @@
+#!/usr/bin/env bash
+set -eu
+
+# Usage:
+#   replace_firtool <firtool_url> <firtool_sha256_url> <firtool_update_version>
+replace_firtool() {
+    local firtool_url=$1
+    local firtool_sha256_url=$2
+    local firtool_update_version=$3
+    local firtool_patch_dir=$4
+
+    # Check if firtool directory exists
+    if [ -d $firtool_patch_dir ]; then
+        echo "Found existing firtool directory in $firtool_patch_dir"
+        echo "If you want to update firtool, please remove the existing firtool directory"
+        exit 0
+    fi
+
+    # Create temporary directory
+    local firtool_temp=$(mktemp -d)
+    echo "Downloading firtool version $firtool_update_version from $firtool_url..."
+    curl -L -o $firtool_temp/firtool.tar.gz $firtool_url
+    echo "Downloading SHA256 checksum from $firtool_sha256_url..."
+    # Check SHA256 checksum
+    check_sha256=$(curl -L $firtool_sha256_url)
+    echo "Checking SHA256 checksum..."
+    echo "$check_sha256 $firtool_temp/firtool.tar.gz" | sha256sum -c -
+
+    if [ $? -ne 0 ]; then
+        echo "SHA256 checksum failed"
+        exit 1
+    fi
+
+    # Extract firtool to patch directory
+    mkdir -p $firtool_patch_dir
+    tar -xzf $firtool_temp/firtool.tar.gz -C $firtool_patch_dir
+    chmod +x $firtool_patch_dir/firtool-$firtool_update_version/bin/firtool
+}
+
+update_firtool() {
+    local firtool_update_version=$1
+    local firtool_patch_dir=$2
+
+    case "$(uname -s)" in
+        Linux*) firtool_arch="linux-x64";;
+        Darwin*)
+            if [ "$(uname -m)" == "arm64" ]; then
+                # CIRCT does not release darwin arm64 binary yet
+                # so we need to build it from source
+                echo "Unsupported darwin architecture"
+                echo "Please build firtool from source, see: https://github.com/llvm/circt?tab=readme-ov-file#setting-this-up"
+                echo "Then copy the built firtool binary to $firtool_patch_dir/firtool-$firtool_update_version/bin/firtool"
+                exit 1
+            else
+                firtool_arch="macos-x64"
+            fi
+            ;;
+        *) echo "Unsupported OS"; exit 1;;
+    esac
+
+    local firtool_url="https://github.com/llvm/circt/releases/download/firtool-${firtool_update_version}/firrtl-bin-${firtool_arch}.tar.gz"
+    local firtool_sha256="https://github.com/llvm/circt/releases/download/firtool-${firtool_update_version}/firrtl-bin-${firtool_arch}.tar.gz.sha256"
+
+    case "$(uname -s)" in
+        Linux*) replace_firtool $firtool_url $firtool_sha256 $firtool_update_version $firtool_patch_dir;;
+        Darwin*) replace_firtool $firtool_url $firtool_sha256 $firtool_update_version $firtool_patch_dir;;
+        *) echo "Unsupported OS"; exit 1;;
+    esac
+}
+
+# Call update_firtool with version and patch directory
+# e.g. update_firtool 1.105.0 `pwd`/patch/firtool
+update_firtool $1 $2
\ No newline at end of file
-- 
2.34.1

