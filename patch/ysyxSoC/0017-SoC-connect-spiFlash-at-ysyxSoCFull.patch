From 3baeba8bae8fffefb0ac9b8e9b3331defdadd29b Mon Sep 17 00:00:00 2001
From: Zihao Yu <yuzihao@ict.ac.cn>
Date: Sun, 29 Aug 2021 12:09:58 +0800
Subject: [PATCH 17/74] SoC: connect spiFlash at ysyxSoCFull

---
 src/SoC.scala        | 4 ++--
 src/Top.scala        | 1 -
 src/device/SPI.scala | 6 +++++-
 3 files changed, 7 insertions(+), 4 deletions(-)

diff --git a/src/SoC.scala b/src/SoC.scala
index bcd52a8b..0a082ced 100644
--- a/src/SoC.scala
+++ b/src/SoC.scala
@@ -111,9 +111,9 @@ class ysyxSoCFull(implicit p: Parameters) extends LazyModule {
     masic.cpu_master <> cpu_master
     cpu_slave <> masic.cpu_slave
 
-    val spi  = IO(chiselTypeOf(masic.spi))
+    val spiFlash = Module(new spiFlash)
     val uart = IO(chiselTypeOf(masic.uart))
-    spi  <> masic.spi
+    spiFlash.io <> masic.spi
     uart <> masic.uart
   }
 }
diff --git a/src/Top.scala b/src/Top.scala
index 6e1897f3..98978fc9 100644
--- a/src/Top.scala
+++ b/src/Top.scala
@@ -15,7 +15,6 @@ class ysyxSoCTop extends Module {
   mdut.cpu_master := DontCare
   mdut.cpu_slave := DontCare
   mdut.uart.rx := true.B
-  mdut.spi.miso := true.B
 }
 
 object Elaborate extends App {
diff --git a/src/device/SPI.scala b/src/device/SPI.scala
index 3e32fac5..e4958d51 100644
--- a/src/device/SPI.scala
+++ b/src/device/SPI.scala
@@ -13,7 +13,6 @@ class SPIIO(val csWidth: Int = 2) extends Bundle {
   val cs = Output(UInt(csWidth.W))
   val mosi = Output(Bool())
   val miso = Input(Bool())
-  val irq_out = Output(Bool())
 }
 
 class spi extends BlackBox {
@@ -22,9 +21,14 @@ class spi extends BlackBox {
     val resetn = Input(Bool())
     val in = Flipped(new APBBundle(APBBundleParameters(addrBits = 32, dataBits = 32)))
     val spi = new SPIIO
+    val spi_irq_out = Output(Bool())
   })
 }
 
+class spiFlash extends BlackBox {
+  val io = IO(Flipped(new SPIIO))
+}
+
 class APBSPI(address: Seq[AddressSet])(implicit p: Parameters) extends LazyModule {
   val node = APBSlaveNode(Seq(APBSlavePortParameters(
     Seq(APBSlaveParameters(
-- 
2.34.1

