From abc4dd516d5e1aef97e58ca421e5ef4d6db1c27d Mon Sep 17 00:00:00 2001
From: Zihao Yu <yuzihao@ict.ac.cn>
Date: Sat, 30 Dec 2023 11:42:03 +0800
Subject: [PATCH 47/74] perip,psram,psram_top_apb: fix pready asserting for two
 cycles

---
 perip/psram/psram_top_apb.v | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/perip/psram/psram_top_apb.v b/perip/psram/psram_top_apb.v
index 3086e765..2614882f 100644
--- a/perip/psram/psram_top_apb.v
+++ b/perip/psram/psram_top_apb.v
@@ -18,6 +18,7 @@ module psram_top_apb (
 );
 
   wire [3:0] din, dout, douten;
+  wire ack;
   EF_PSRAM_CTRL_wb u0 (
     .clk_i(clk),
     .rst_i(!resetn),
@@ -27,7 +28,7 @@ module psram_top_apb (
     .sel_i(in_pstrb),
     .cyc_i(in_penable),
     .stb_i(in_psel),
-    .ack_o(in_pready),
+    .ack_o(ack),
     .we_i(in_pwrite),
   
     .sck(qspi_sck),
@@ -37,6 +38,7 @@ module psram_top_apb (
     .douten(douten)
   );
   
+  assign in_pready = ack && in_psel;
   assign in_pslverr = 1'b0;
   assign qspi_dio[0] = douten[0] ? dout[0] : 1'bz;
   assign qspi_dio[1] = douten[1] ? dout[1] : 1'bz;
-- 
2.34.1

