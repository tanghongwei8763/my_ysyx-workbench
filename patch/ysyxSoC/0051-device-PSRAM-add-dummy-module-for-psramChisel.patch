From b02c471bc1df03cbcb0f0775252984d2e26c9bf6 Mon Sep 17 00:00:00 2001
From: Zihao Yu <yuzihao@ict.ac.cn>
Date: Sun, 31 Dec 2023 20:57:13 +0800
Subject: [PATCH 51/74] device,PSRAM: add dummy module for psramChisel

---
 src/device/PSRAM.scala  |  5 +++++
 src/util/TriState.scala | 38 ++++++++++++++++++++++++++++++++++++++
 2 files changed, 43 insertions(+)
 create mode 100644 src/util/TriState.scala

diff --git a/src/device/PSRAM.scala b/src/device/PSRAM.scala
index eb33012e..cb19872d 100644
--- a/src/device/PSRAM.scala
+++ b/src/device/PSRAM.scala
@@ -28,6 +28,11 @@ class psram extends BlackBox {
   val io = IO(Flipped(new QSPIIO))
 }
 
+class psramChisel extends RawModule {
+  val io = IO(Flipped(new QSPIIO))
+  val di = TriStateInBuf(io.dio, 0.U, false.B) // change this if you need
+}
+
 class APBPSRAM(address: Seq[AddressSet])(implicit p: Parameters) extends LazyModule {
   val node = APBSlaveNode(Seq(APBSlavePortParameters(
     Seq(APBSlaveParameters(
diff --git a/src/util/TriState.scala b/src/util/TriState.scala
new file mode 100644
index 00000000..16e687fb
--- /dev/null
+++ b/src/util/TriState.scala
@@ -0,0 +1,38 @@
+package ysyx
+
+import chisel3._
+import chisel3.util._
+import chisel3.experimental.Analog
+
+class TriStateInBuf(bits: Int) extends BlackBox(Map("width" -> bits)) with HasBlackBoxInline {
+  val io = IO(new Bundle {
+    val dio = Analog(bits.W)
+    val dout = Input(UInt(bits.W))
+    val out_en = Input(Bool())
+    val din = Output(UInt(bits.W))
+  })
+
+  setInline("TriStateInBuf.v",
+    """module TriStateInBuf #(
+      |  parameter width = 1
+      |)(
+      |    inout  [width-1:0] dio,
+      |    input  [width-1:0] dout,
+      |    input              out_en,
+      |    output [width-1:0] din
+      |);
+      |  assign din = dio;
+      |  assign dio = out_en ? dout : {width{1'bz}};
+      |endmodule
+    """.stripMargin)
+}
+
+object TriStateInBuf {
+  def apply(dio: Analog, dout: UInt, out_en: Bool) = {
+    val buf = Module(new TriStateInBuf(dio.getWidth))
+    buf.io.dio <> dio
+    buf.io.dout := dout
+    buf.io.out_en := out_en
+    buf.io.din
+  }
+}
-- 
2.34.1

