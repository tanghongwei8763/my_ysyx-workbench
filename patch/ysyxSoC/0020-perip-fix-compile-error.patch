From ec3665c64236eb9783ee660a5115383a5dcdfd99 Mon Sep 17 00:00:00 2001
From: Chen Lu <181250012@smail.nju.edu.cn>
Date: Sun, 29 Aug 2021 22:54:10 +0800
Subject: [PATCH 20/74] perip: fix compile error

---
 perip/spi/rtl/spi_clgen.v              | 1 -
 perip/spi/rtl/spi_shift.v              | 1 -
 perip/spi/rtl/spi_top.v                | 1 -
 perip/uart16550/rtl/uart_receiver.v    | 3 +--
 perip/uart16550/rtl/uart_regs.v        | 7 ++-----
 perip/uart16550/rtl/uart_rfifo.v       | 3 +--
 perip/uart16550/rtl/uart_tfifo.v       | 3 +--
 perip/uart16550/rtl/uart_transmitter.v | 9 ++++-----
 8 files changed, 9 insertions(+), 19 deletions(-)

diff --git a/perip/spi/rtl/spi_clgen.v b/perip/spi/rtl/spi_clgen.v
index 17c09e06..5e58f7c2 100644
--- a/perip/spi/rtl/spi_clgen.v
+++ b/perip/spi/rtl/spi_clgen.v
@@ -39,7 +39,6 @@
 //////////////////////////////////////////////////////////////////////
 
 `include "spi_defines.v"
-`include "timescale.v"
 
 module spi_clgen (clk_in, rst, go, enable, last_clk, divider, clk_out, pos_edge, neg_edge);
 
diff --git a/perip/spi/rtl/spi_shift.v b/perip/spi/rtl/spi_shift.v
index 1f2ba1d7..fac52a42 100644
--- a/perip/spi/rtl/spi_shift.v
+++ b/perip/spi/rtl/spi_shift.v
@@ -39,7 +39,6 @@
 //////////////////////////////////////////////////////////////////////
 
 `include "spi_defines.v"
-`include "timescale.v"
 
 module spi_shift (clk, rst, latch, byte_sel, len, lsb, go,
                   pos_edge, neg_edge, rx_negedge, tx_negedge,
diff --git a/perip/spi/rtl/spi_top.v b/perip/spi/rtl/spi_top.v
index ebcbcb42..73af8756 100644
--- a/perip/spi/rtl/spi_top.v
+++ b/perip/spi/rtl/spi_top.v
@@ -40,7 +40,6 @@
 
 
 `include "spi_defines.v"
-`include "timescale.v"
 
 module spi_top
 (
diff --git a/perip/uart16550/rtl/uart_receiver.v b/perip/uart16550/rtl/uart_receiver.v
index 280e2939..f5646063 100644
--- a/perip/uart16550/rtl/uart_receiver.v
+++ b/perip/uart16550/rtl/uart_receiver.v
@@ -196,8 +196,7 @@
 `timescale 1ns/1ns
 // synopsys translate_on
 
-`include "uart16550/uart_defines.v"
-`include "uart16550/uart_rfifo.v"
+`include "uart_defines.v"
 
 module uart_receiver (clk, wb_rst_i, lcr, rf_pop, srx_pad_i, enable,
 	counter_t, rf_count, rf_data_out, rf_error_bit, rf_overrun, rx_reset, lsr_mask, rstate, rf_push_pulse);
diff --git a/perip/uart16550/rtl/uart_regs.v b/perip/uart16550/rtl/uart_regs.v
index 20a2d6f6..b48d1d6c 100644
--- a/perip/uart16550/rtl/uart_regs.v
+++ b/perip/uart16550/rtl/uart_regs.v
@@ -227,10 +227,7 @@
 `timescale 1ns/1ns
 // synopsys translate_on
 
-`include "uart16550/uart_defines.v"
-`include "uart16550/uart_transmitter.v"
-`include "uart16550/uart_receiver.v"
-`include "uart16550/uart_sync_flops.v"
+`include "uart_defines.v"
 
 `define UART_DL1 7:0
 `define UART_DL2 15:8
@@ -414,7 +411,7 @@ always @(dl or dlab or ier or iir or scratch
 begin
     case (wb_addr_i)
         `UART_REG_RB   : wb_dat_o = dlab ? dl[`UART_DL1] : rf_data_out[10:3];
-        `UART_REG_IE   : wb_dat_o = dlab ? dl[`UART_DL2] : ier;
+        `UART_REG_IE   : wb_dat_o = dlab ? dl[`UART_DL2] : {4'b0, ier};
         `UART_REG_II   : wb_dat_o = {4'b1100,iir};
         `UART_REG_LC   : wb_dat_o = lcr;
         `UART_REG_LS   : wb_dat_o = lsr;
diff --git a/perip/uart16550/rtl/uart_rfifo.v b/perip/uart16550/rtl/uart_rfifo.v
index e6b786b7..20dcd4b7 100644
--- a/perip/uart16550/rtl/uart_rfifo.v
+++ b/perip/uart16550/rtl/uart_rfifo.v
@@ -148,8 +148,7 @@
 `timescale 1ns/1ns
 // synopsys translate_on
 
-`include "uart16550/uart_defines.v"
-`include "uart16550/raminfr.v"
+`include "uart_defines.v"
 
 module uart_rfifo (clk,
 	wb_rst_i, data_in, data_out,
diff --git a/perip/uart16550/rtl/uart_tfifo.v b/perip/uart16550/rtl/uart_tfifo.v
index aadbb20e..dc5f9478 100644
--- a/perip/uart16550/rtl/uart_tfifo.v
+++ b/perip/uart16550/rtl/uart_tfifo.v
@@ -142,8 +142,7 @@
 `timescale 1ns/1ns
 // synopsys translate_on
 
-`include "uart16550/uart_defines.v"
-`include "uart16550/raminfr.v"
+`include "uart_defines.v"
 
 module uart_tfifo (clk,
     wb_rst_i, data_in, data_out,
diff --git a/perip/uart16550/rtl/uart_transmitter.v b/perip/uart16550/rtl/uart_transmitter.v
index 0de45bfc..bf40fb49 100644
--- a/perip/uart16550/rtl/uart_transmitter.v
+++ b/perip/uart16550/rtl/uart_transmitter.v
@@ -152,8 +152,7 @@
 `timescale 1ns/1ns
 // synopsys translate_on
 
-`include "uart16550/uart_defines.v"
-`include "uart16550/uart_tfifo.v"
+`include "uart_defines.v"
 
 module uart_transmitter (clk, wb_rst_i, lcr, tf_push, wb_dat_i, enable,
                          stx_pad_o, tstate, tf_count, tx_reset, lsr_mask);
@@ -312,7 +311,7 @@ always @(posedge clk or posedge wb_rst_i) begin
                 else
                 if (counter == 5'b00001)
                 begin
-                    counter <= #1 4'b0;
+                    counter <= #1 5'b0;
                     tstate <= #1 s_send_stop;
                 end
                 else
@@ -322,8 +321,8 @@ always @(posedge clk or posedge wb_rst_i) begin
     s_send_stop :  begin
                 if (~|counter)
                   begin
-                        casex ({lcr[`UART_LC_SB],lcr[`UART_LC_BITS]})
-                          3'b0xx:      counter <= #1 5'b01101;     // 1 stop bit ok igor
+                        casez ({lcr[`UART_LC_SB],lcr[`UART_LC_BITS]})
+                          3'b0zz:      counter <= #1 5'b01101;     // 1 stop bit ok igor
                           3'b100:      counter <= #1 5'b10101;     // 1.5 stop bit
                           default:      counter <= #1 5'b11101;     // 2 stop bits
                         endcase
-- 
2.34.1

