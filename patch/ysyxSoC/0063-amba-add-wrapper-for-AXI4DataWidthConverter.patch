From 36b59fdd8e11a7b5db16e547605175b5d91dd396 Mon Sep 17 00:00:00 2001
From: Zihao Yu <yuzihao@ict.ac.cn>
Date: Wed, 10 Apr 2024 07:40:39 +0800
Subject: [PATCH 63/74] amba: add wrapper for AXI4DataWidthConverter

---
 perip/amba/axi4_data_width_converter_64to32.v | 66 +++++++++++++++++++
 src/amba/AXI4DataWidthConverter.scala         | 23 +++++++
 src/device/SDRAM.scala                        |  7 +-
 3 files changed, 95 insertions(+), 1 deletion(-)
 create mode 100644 perip/amba/axi4_data_width_converter_64to32.v
 create mode 100644 src/amba/AXI4DataWidthConverter.scala

diff --git a/perip/amba/axi4_data_width_converter_64to32.v b/perip/amba/axi4_data_width_converter_64to32.v
new file mode 100644
index 00000000..dd24cdba
--- /dev/null
+++ b/perip/amba/axi4_data_width_converter_64to32.v
@@ -0,0 +1,66 @@
+module AXI4DataWidthConverter64to32(
+  input         clock,
+  input         reset,
+
+  output        in_arready,
+  input         in_arvalid,
+  input  [3:0]  in_arid,
+  input  [31:0] in_araddr,
+  input  [7:0]  in_arlen,
+  input  [2:0]  in_arsize,
+  input  [1:0]  in_arburst,
+  input         in_rready,
+  output        in_rvalid,
+  output [3:0]  in_rid,
+  output [63:0] in_rdata,
+  output [1:0]  in_rresp,
+  output        in_rlast,
+  output        in_awready,
+  input         in_awvalid,
+  input  [3:0]  in_awid,
+  input  [31:0] in_awaddr,
+  input  [7:0]  in_awlen,
+  input  [2:0]  in_awsize,
+  input  [1:0]  in_awburst,
+  output        in_wready,
+  input         in_wvalid,
+  input  [63:0] in_wdata,
+  input  [7:0]  in_wstrb,
+  input         in_wlast,
+                in_bready,
+  output        in_bvalid,
+  output [3:0]  in_bid,
+  output [1:0]  in_bresp,
+
+  input         out_arready,
+  output        out_arvalid,
+  output [3:0]  out_arid,
+  output [31:0] out_araddr,
+  output [7:0]  out_arlen,
+  output [2:0]  out_arsize,
+  output [1:0]  out_arburst,
+  output        out_rready,
+  input         out_rvalid,
+  input  [3:0]  out_rid,
+  input  [31:0] out_rdata,
+  input  [1:0]  out_rresp,
+  input         out_rlast,
+  input         out_awready,
+  output        out_awvalid,
+  output [3:0]  out_awid,
+  output [31:0] out_awaddr,
+  output [7:0]  out_awlen,
+  output [2:0]  out_awsize,
+  output [1:0]  out_awburst,
+  input         out_wready,
+  output        out_wvalid,
+  output [31:0] out_wdata,
+  output [3:0]  out_wstrb,
+  output        out_wlast,
+                out_bready,
+  input         out_bvalid,
+  input  [3:0]  out_bid,
+  input  [1:0]  out_bresp
+);
+
+endmodule
diff --git a/src/amba/AXI4DataWidthConverter.scala b/src/amba/AXI4DataWidthConverter.scala
new file mode 100644
index 00000000..36eea8c2
--- /dev/null
+++ b/src/amba/AXI4DataWidthConverter.scala
@@ -0,0 +1,23 @@
+package ysyx
+
+import chisel3._
+import chisel3.util._
+
+import freechips.rocketchip.amba.axi4._
+import freechips.rocketchip.util._
+
+class AXI4DataWidthConverter64to32IO extends Bundle {
+  val clock = Input(Clock())
+  val reset = Input(Bool())
+  val in = Flipped(new AXI4Bundle(AXI4BundleParameters(addrBits = 32, dataBits = 64, idBits = 4)))
+  val out = new AXI4Bundle(AXI4BundleParameters(addrBits = 32, dataBits = 32, idBits = 4))
+}
+
+class AXI4DataWidthConverter64to32 extends BlackBox {
+  val io = IO(new AXI4DataWidthConverter64to32IO)
+}
+
+class AXI4DataWidthConverter64to32Chisel extends Module {
+  val io = IO(new AXI4DataWidthConverter64to32IO)
+  io.out <> io.in
+}
diff --git a/src/device/SDRAM.scala b/src/device/SDRAM.scala
index 7879b3c1..403647de 100644
--- a/src/device/SDRAM.scala
+++ b/src/device/SDRAM.scala
@@ -66,10 +66,15 @@ class AXI4SDRAM(address: Seq[AddressSet])(implicit p: Parameters) extends LazyMo
     val (in, _) = node.in(0)
     val sdram_bundle = IO(new SDRAMIO)
 
+    val converter = Module(new AXI4DataWidthConverter64to32)
+    converter.io.clock := clock
+    converter.io.reset := reset.asBool
+    converter.io.in <> in
+
     val msdram = Module(new sdram_top_axi)
     msdram.io.clock := clock
     msdram.io.reset := reset.asBool
-    msdram.io.in <> in
+    msdram.io.in <> converter.io.out
     sdram_bundle <> msdram.io.sdram
   }
 }
-- 
2.34.1

